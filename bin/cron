#!/usr/bin/env node

const yargs = require('yargs/yargs');
const cron = require('node-cron');
const shell = require('shelljs');
const {hideBin} = require('yargs/helpers');
const {defaultClient} = require('../src/whitelist');

process.on('SIGTERM', () => {
	process.exit(0);
});
process.on('SIGINT', () => {
	process.exit(0);
});

// eslint-disable-next-line no-unused-expressions
yargs(hideBin(process.argv))
	.command({
		command: 'fix-whitelist-job [cronPeriod]',
		aliases: ['wj'],
		desc: 'Based on cron period, fix not whitelisted dids  periodically (defulat 5 mins)',
		handler: fixPeriodicallyCommand
	})
	.onFinishCommand(() => {
		process.exit(0);
	})
	.demandCommand()
	.help()
	.strict().argv;

async function fixPeriodicallyCommand(argv) {
	const period = argv.cronPeriod || '*/5 * * * *';

	cron.schedule(period, () => {
		console.log('Running fix whitelist');
		try {
			shell.exec(`node ${__dirname}/issuer-cli fnwl`);
			console.log('fix whitelist complete!');
		} catch (error) {
			console.error(error);
		}
	});
	return new Promise(() => {});
}
